# vim: filetype=bash

function unix-path() {
  echo "$@" | xargs -d ';' cygpath -u | grep . | paste -sd : -
}

case "$(uname -s)" in
Darwin*)
  export PATH="/Applications/Visual Studio Code.app/Contents/Resources/app/bin":$PATH
  alias studio="open -a /Applications/Android\ Studio.app"
  ;;
MSYS_NT*)
  export PATH=$(unix-path "$PATH")
  export MSYS=winsymlinks:nativestrict
  export MSYS2_PATH_TYPE=inherit
  ;;&
*_NT*)
  export PATH="/c/PROGRA~1/Microsoft Visual Studio/2022/Community/VC/Tools/Llvm/x64/bin":$PATH
  export PATH="/c/PROGRA~2/Microsoft Visual Studio/Shared/Python39_64":$PATH
  export PATH="/c/PROGRA~1/Microsoft Visual Studio/2022/Community/MSBuild/Microsoft/VisualStudio/NodeJs":$PATH
  alias npm="cmd //c npm.cmd"
  ;;
*)
  ;;
esac

export PATH="$HOME/.nimble/bin":"$HOME/.local/bin":"$HOME/.dotfiles/scripts":$PATH

export GIT_CONFIG_GLOBAL="$HOME/.dotfiles/gitconfig/main"

{{- if (index . "gitlab") }}
export GITLAB_ACCESS_TOKEN={{ .gitlab.token | quote }}
{{- end }}

{{- if (index . "github") }}
export GITHUB_ACCESS_TOKEN={{ .github.token | quote }}
{{- end }}

if [ -z "$EMU" ]; then
  export STARSHIP_CONFIG="$HOME/.config/starship.default.toml"
fi

if [ ! "$(command -v git)" ]; then
  sh -c "$(curl -fsSL https://starship.rs/install.sh)" -- --bin-dir "$HOME/.local/bin" --yes
fi

function silent-background() {
  ("$@" &>/dev/null &)
}

if [ ! -z "$NVIM" ]; then
  export EDITOR="$HOME/.dotfiles/scripts/nvim-nested"

  function _nvim_remote() {
    command nvim --clean --headless --server "$NVIM" "$@"
  }

  function load-nvim-env() {
    for var in "$@"; do
      local val=$(_nvim_remote --remote-expr "\$$var" 2>&1)
      if [ "$var" == "PATH" ]; then
        val=$(unix-path "$val")
      fi
      eval $var="\$val"
      export $var
    done
  }

  function cd() {
    command cd "$@"
    local dir="$(cygpath -m "$PWD")"
    silent-background _nvim_remote --remote-expr "v:lua.fn.set_terminal_dir(\"$dir\")"
  }

  function git() {
    command git "$@"
    silent-background _nvim_remote --remote-expr "v:lua.fn.refresh_git_info()"
  }

  function nvim() {
    if [ $# -eq 0 ]; then
      local dir="$(cygpath -m "$PWD")"
      silent-background _nvim_remote --remote-expr "v:lua.fn.open_workspace(\"$dir\")"
    else
      silent-background _nvim_remote --remote-expr "v:lua.fn.open_tab(\"$@\")"
    fi
  }

  function workspace() {
    source "$HOME/.dotfiles/scripts/workspace"
    nvim
  }

  function exit() {
    _nvim_remote --remote-send "<cmd>quitall<CR>"
  }
else
  export EDITOR="nvim"

  function workspace() {
    source "$HOME/.dotfiles/scripts/workspace"
  }
fi

# General aliases

alias c='cd'
alias e='nvim'
alias g='git'
alias l='ls'
alias vim='nvim'
alias w='workspace'

# Config aliases

alias ce='cd ~/.local/share/chezmoi && nvim'

# Git aliases

function gc() {
  git commit -m "$*"
}

alias ga='git add -p'
alias gp='git pu'
alias gs='git st'
alias gu='git pull'
alias tl='tig log'
